


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DailyMoodRemoteDataSource</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.zurtar.mhma.data</a>
</div>

<h1>Coverage Summary for Class: DailyMoodRemoteDataSource (com.zurtar.mhma.data)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DailyMoodRemoteDataSource</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DailyMoodRemoteDataSource$addMoodEntry$1</td>
  </tr>
  <tr>
    <td class="name">DailyMoodRemoteDataSource$fetchMoodEntries$1</td>
  </tr>
  <tr>
    <td class="name">DailyMoodRemoteDataSource$getMoodEntries$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.zurtar.mhma.data
&nbsp;
&nbsp;import android.util.Log
&nbsp;import com.google.android.gms.common.internal.safeparcel.SafeParcelable.Field
&nbsp;import com.google.firebase.Firebase
&nbsp;import com.google.firebase.auth.auth
&nbsp;import com.google.firebase.firestore.FirebaseFirestore
&nbsp;import com.google.firebase.firestore.ListenSource
&nbsp;import com.google.firebase.firestore.MetadataChanges
&nbsp;import com.google.firebase.firestore.PropertyName
&nbsp;import com.google.firebase.firestore.SnapshotListenOptions
&nbsp;import com.google.firebase.firestore.toObjects
&nbsp;import com.zurtar.mhma.data.models.DateSerializer
&nbsp;import kotlinx.coroutines.channels.awaitClose
&nbsp;import kotlinx.coroutines.flow.Flow
&nbsp;import kotlinx.coroutines.flow.callbackFlow
&nbsp;import kotlinx.coroutines.tasks.await
&nbsp;import kotlinx.serialization.KSerializer
&nbsp;import kotlinx.serialization.SerialName
&nbsp;import kotlinx.serialization.Serializable
&nbsp;import java.util.Date
&nbsp;import javax.inject.Inject
&nbsp;import javax.inject.Singleton
&nbsp;import kotlinx.serialization.descriptors.PrimitiveKind
&nbsp;import kotlinx.serialization.descriptors.PrimitiveSerialDescriptor
&nbsp;import kotlinx.serialization.descriptors.SerialDescriptor
&nbsp;import kotlinx.serialization.encoding.Decoder
&nbsp;import kotlinx.serialization.encoding.Encoder
&nbsp;import kotlin.random.Random
&nbsp;
&nbsp;
&nbsp;@Serializable
&nbsp;data class DailyEvaluationEntryDBSafe(
&nbsp;    val selectedEmotions: List&lt;String&gt; = listOf(),
&nbsp;    val emotionIntensities: List&lt;Float&gt; = listOf(0f, 0f, 0f),
&nbsp;    val emotionsMap: Map&lt;String, Float&gt; = mapOf(),
&nbsp;    val stressLevel: String = &quot;default_initial&quot;,
&nbsp;
&nbsp;
&nbsp;    @PropertyName(&quot;strongestEmotion_first&quot;)
&nbsp;    @get:PropertyName(&quot;strongestEmotion_first&quot;)
&nbsp;    val strongestEmotionFirst: String? = null,
&nbsp;
&nbsp;    @PropertyName(&quot;strongestEmotion_second&quot;)
&nbsp;    @get:PropertyName(&quot;strongestEmotion_second&quot;)
&nbsp;    val strongestEmotionSecond: Float = 0f,
&nbsp;
&nbsp;    @Serializable(with = DateSerializer::class)
&nbsp;    val dateCompleted: Date? = null
&nbsp;)
&nbsp;
&nbsp;@Serializable
&nbsp;data class DailyEvaluationEntry(
&nbsp;    val selectedEmotions: List&lt;String&gt; = listOf(),
&nbsp;    val emotionIntensities: List&lt;Float&gt; = listOf(0f, 0f, 0f),
&nbsp;    val emotionsMap: Map&lt;String, Float&gt; = mapOf(),
&nbsp;    val stressLevel: String = &quot;default_initial&quot;,
&nbsp;
&nbsp;    val strongestEmotion: Pair&lt;String, Float&gt; = Pair(&quot;&quot;, 0f),
&nbsp;
&nbsp;    @Serializable(with = DateSerializer::class)
&nbsp;    val dateCompleted: Date? = null
&nbsp;)
&nbsp;
&nbsp;
&nbsp;object EmotionPairSerializer : KSerializer&lt;Pair&lt;String, Float&gt;&gt; {
&nbsp;    override val descriptor: SerialDescriptor =
&nbsp;        PrimitiveSerialDescriptor(&quot;DateSerializer&quot;, PrimitiveKind.STRING)
&nbsp;
&nbsp;    override fun serialize(encoder: Encoder, value: Pair&lt;String, Float&gt;) {
&nbsp;        encoder.encodeString(value.first)
&nbsp;        encoder.encodeFloat(value.second)
&nbsp;    }
&nbsp;
&nbsp;    override fun deserialize(decoder: Decoder): Pair&lt;String, Float&gt; {
&nbsp;        return Pair(decoder.decodeString(), decoder.decodeFloat())
&nbsp;    }
&nbsp;
&nbsp;}
&nbsp;
&nbsp;@Singleton
&nbsp;class DailyMoodRepository @Inject constructor(
&nbsp;    private var dailyMoodRemoteDataSource: DailyMoodRemoteDataSource
&nbsp;) {
&nbsp;
&nbsp;    suspend fun fetchMoodEntries(): List&lt;DailyEvaluationEntry&gt; =
&nbsp;        dailyMoodRemoteDataSource.fetchMoodEntries()
&nbsp;
&nbsp;    suspend fun addMoodEntry(moodEntry: DailyEvaluationEntry) =
&nbsp;        dailyMoodRemoteDataSource.addMoodEntry(moodEntry)
&nbsp;
&nbsp;    fun getMoodEntries(): Flow&lt;List&lt;DailyEvaluationEntry&gt;&gt; =
&nbsp;        dailyMoodRemoteDataSource.getMoodEntries()
&nbsp;}
&nbsp;
&nbsp;@Singleton
<b class="nc">&nbsp;class DailyMoodRemoteDataSource @Inject constructor(</b>
<b class="nc">&nbsp;    private val fireStoreDatasource: FirebaseFirestore</b>
&nbsp;) {
<b class="nc">&nbsp;    private val TAG = &quot;DailyMoodRemoteDataSource&quot;</b>
&nbsp;
&nbsp;    suspend fun addMoodEntry(moodEntry: DailyEvaluationEntry) {
<b class="nc">&nbsp;        val response = fireStoreDatasource.collection(&quot;users&quot;)</b>
<b class="nc">&nbsp;            .document(Firebase.auth.currentUser?.uid!!)</b>
<b class="nc">&nbsp;            .collection(&quot;DailyMoodEntries&quot;)</b>
<b class="nc">&nbsp;            .add(moodEntry.toDBSafe()).await()</b>
&nbsp;    }
&nbsp;
&nbsp;    suspend fun fetchMoodEntries(): List&lt;DailyEvaluationEntry&gt; {
<b class="nc">&nbsp;        val documents = fireStoreDatasource.collection(&quot;users&quot;)</b>
<b class="nc">&nbsp;            .document(Firebase.auth.currentUser?.uid!!)</b>
<b class="nc">&nbsp;            .collection(&quot;DailyMoodEntries&quot;)</b>
<b class="nc">&nbsp;            .get().await()</b>
&nbsp;
<b class="nc">&nbsp;        for (doc in documents) {</b>
<b class="nc">&nbsp;            Log.d(&quot;FirestoreDocument&quot;, doc.data.toString())</b>
&nbsp;        }
&nbsp;
&nbsp;
<b class="nc">&nbsp;        return fireStoreDatasource.collection(&quot;users&quot;)</b>
<b class="nc">&nbsp;            .document(Firebase.auth.currentUser?.uid!!)</b>
<b class="nc">&nbsp;            .collection(&quot;DailyMoodEntries&quot;)</b>
<b class="nc">&nbsp;            .get().await().toObjects&lt;DailyEvaluationEntryDBSafe&gt;().toNormalList()</b>
&nbsp;
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    fun getMoodEntries(): Flow&lt;List&lt;DailyEvaluationEntry&gt;&gt; = callbackFlow {</b>
&nbsp;        val options = SnapshotListenOptions.Builder()
&nbsp;            .setMetadataChanges(MetadataChanges.INCLUDE)
&nbsp;            .setSource(ListenSource.DEFAULT)
&nbsp;            .build();
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;        val listenerRegistration = fireStoreDatasource.collection(&quot;users&quot;)</b>
<b class="nc">&nbsp;            .document(Firebase.auth.currentUser?.uid!!)</b>
<b class="nc">&nbsp;            .collection(&quot;DailyMoodEntries&quot;).addSnapshotListener(options) { snapshot, e -&gt;</b>
&nbsp;                if (e != null) {
<b class="nc">&nbsp;                    Log.w(TAG, &quot;Listen failed.&quot;, e)</b>
<b class="nc">&nbsp;                    return@addSnapshotListener</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                Log.w(TAG, snapshot.toString())</b>
<b class="nc">&nbsp;</b>
&nbsp;                snapshot?.toObjects&lt;DailyEvaluationEntryDBSafe&gt;()
&nbsp;                    ?.let { trySend(it.toNormalList()) }
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;        trySend(listOf&lt;DailyEvaluationEntry&gt;())</b>
<b class="nc">&nbsp;        awaitClose { listenerRegistration.remove() }</b>
&nbsp;    }
&nbsp;}
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;fun List&lt;DailyEvaluationEntry&gt;.toDBSafeList(): List&lt;DailyEvaluationEntryDBSafe&gt; {</b>
&nbsp;    return this.map { it.toDBSafe() }
&nbsp;}
&nbsp;
&nbsp;fun List&lt;DailyEvaluationEntryDBSafe&gt;.toNormalList(): List&lt;DailyEvaluationEntry&gt; {
&nbsp;    return this.map { it.toNormal() }
&nbsp;}
&nbsp;
&nbsp;
&nbsp;fun DailyEvaluationEntry.toDBSafe(): DailyEvaluationEntryDBSafe {
&nbsp;    return DailyEvaluationEntryDBSafe(
&nbsp;        selectedEmotions = this.selectedEmotions,
&nbsp;        emotionIntensities = this.emotionIntensities,
&nbsp;        emotionsMap = this.emotionsMap,
&nbsp;        stressLevel = this.stressLevel,
&nbsp;        strongestEmotionFirst = this.emotionsMap.entries.sortedByDescending { it.value }?.first()
&nbsp;            ?.toPair()?.first ?: listOf(&quot;Fearful&quot;, &quot;Sad&quot;, &quot;Angry&quot;).shuffled().first(),
&nbsp;        strongestEmotionSecond = this.emotionsMap.entries.sortedByDescending { it.value }?.first()
&nbsp;            ?.toPair()?.second ?: Random.nextInt(0, 10).toFloat(),
&nbsp;        dateCompleted = this.dateCompleted
&nbsp;    )
&nbsp;}
&nbsp;
&nbsp;fun DailyEvaluationEntryDBSafe.toNormal(): DailyEvaluationEntry {
&nbsp;    return DailyEvaluationEntry(
&nbsp;        selectedEmotions = this.selectedEmotions,
&nbsp;        emotionIntensities = this.emotionIntensities,
&nbsp;        emotionsMap = this.emotionsMap,
&nbsp;        stressLevel = this.stressLevel,
&nbsp;        strongestEmotion = Pair(this.strongestEmotionFirst ?: &quot;Other&quot;, this.strongestEmotionSecond),
&nbsp;        dateCompleted = this.dateCompleted
&nbsp;    )
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-04-03 12:43</div>
</div>
</body>
</html>
